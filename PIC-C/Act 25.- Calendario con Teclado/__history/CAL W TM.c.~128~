//----------- MAIN LIBRARY ----------
      #include <18F452.h> 
//------- FUSES CONFIGURATION -------
#fuses NOWDT,HS,PUT,NOPROTECT,NOBROWNOUT,NOLVP,NOCPD
#use delay(clock=4MHz)
//---------- EXT LIBRARIES -----------
#include <lcd.c>

#include <DS1307 ES.c>
//----------- SET OUTPUTS -----------
//--Ports-
#byte Port_B  = 0X0F81 
#byte Tris_B  = 0x0F93

#byte Port_C  = 0x0F82
#byte Tris_C  = 0x0F94

//--Var--
int8 NPC,ANPC;
int8 set;
//--Inicio--
void main(){
         //Set Outputs
         
         int8 dow=1,d=19,m=05,yr=04;
         int8 h=23,min=59,s=59;
         int8 count1;
         char fecha[5];
         
         Tris_B=0x00;
        
         lcd_init();//initialize the lcd    
          
         ds1307_set_date_time(d,m,yr,dow,h,min,s);//we set the time
        
         while(true){
     inicio:
         //Calendario DS
         
         Tris_B=0x00;
         Tris_C=0xF0;
         ds1307_get_date(d,m,yr,dow);//get the values of day month year and day of week
         ds1307_get_time(h,min,s); //get the values of hour minute and second
         ds1307_get_day_of_week(fecha);//get the day of week in string
         lcd_gotoxy(1,1);//row 1
         printf(lcd_putc,"%s %02u/%02u/20%02u",fecha,d,m,yr);//we print the dow,day month and year
         lcd_gotoxy(1,2);//row 2
         printf(lcd_putc,"%02u:%02u:%02u",h,min,s);//we print the time
         delay_ms(100);
         //Teclado Matricial
         
         NPC=~Port_C;
         ANPC=NPC & 0xF0;
         while(ANPC != 0x00)
         {
     tm:
            Port_C=0xFE; //XXXX 0001 -> 1111 1110 turn up the Row1         
            switch(Port_C){  
               case 0x7E: //Set 
               if(set<7){
                  set++;
                     if(Port_C==0x7E){}
                     else{
                     delay_us(20);
                     break;}
                  }                
               else{set=0;
                  break;}
             }//End switch 1st Row

             Port_C=0xFD; //XXXX 0010->1111 1101 
             switch(Port_C)
            {
               case 0x7D: //Up 
                  switch(set){
                  case 1:
                     if(yr==99){
                        yr=0;
                     }
                     else yr++;
                     //BTFSC   
                     while(bit_test(Port_C,7)==0){}
                     delay_us(20);
                     break;
                  case 2:
                     m++;
                     break;
                  case 3:
                     d++;
                     break;
               }//End switch 2nd row
             Port_C=0xFB; //XXXX 0100->1111 1011         
             switch(Port_C)
               {             
               case 0x7B: //Down
                  lcd_gotoxy(8,1);
                  printf(lcd_putc,"C");
                  break;
               }//End Switch 3rd Row
         lcd_gotoxy(1,1);//row 1
         printf(lcd_putc,"%s %02u/%02u/20%02u",fecha,d,m,yr);//we print the dow,day month and year
         lcd_gotoxy(1,2);//row 2
         printf(lcd_putc,"%02u:%02u:%02u",h,min,s);//we print the time
         delay_ms(100);
          }//End ANPC bracket  
      
        
           
     //end while
         
//end main
  
   

